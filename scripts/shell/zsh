#!/usr/bin/env bash

source "$DOTLY_PATH/scripts/core/_main.sh"

##? ZSH helpers
##?
##? Usage:
##?   zsh optimize
##?   zsh test_performance
##?   zsh reload_completions
##?   zsh clean_cache
##?   zsh fix_permissions
docs::parse "$@"

case $1 in
"optimize")
  asl_conf=$(sed 's/notice] store/critical] store/g' /etc/asl.conf)
  sudo sh -c "echo '$asl_conf' > /etc/asl.conf"
  echo "ASL only storing critical files!"

  find "$DOTFILES_PATH/shell/zsh" -name '*.zwc' -exec rm -rf {} \;
  find "$DOTFILES_PATH/shell/zsh" -name '*.old' -exec rm -rf {} \;
  find "$DOTLY_PATH/modules/zimfw" -name '*.zwc' -exec rm -rf {} \;
  find "$DOTLY_PATH/modules/zimfw" -name '*.old' -exec rm -rf {} \;

  /bin/zsh -c "source ${ZDOTDIR:-${HOME}}/.zlogin"

  "$DOTLY_PATH/bin/dot" shell zsh reload_completions
  ;;
"test_performance")
  script::depends_on hyperfine
  HOMBREW_PREFIX="${HOMBREW_PREFIX:-$(brew --prefix)}"

  if [[ -n "$HOMEBREW_PREFIX" && -x "${HOMBREW_PREFIX}/bin/zsh" ]]; then
    hyperfine '/bin/zsh -i -c exit' "${HOMBREW_PREFIX}/bin/zsh -i -c exit" --warmup 1
  else
    hyperfine '/bin/zsh -i -c exit' --warmup 1
  fi

  echo ""
  echo "ZSH INFO:"
  echo "  💾 System ZSH 📂 /bin/zsh              - $(/bin/zsh --version)"

  if [[ -n "$HOMEBREW_PREFIX" && -x "${HOMBREW_PREFIX}/bin/zsh" ]]; then
    echo "  🍺 Brew ZSH  📂 ${HOMBREW_PREFIX}/bin/zsh  - $("${HOMBREW_PREFIX}/bin/zsh" --version)"
  fi

  echo ""
  echo "✨ Currently using $(command -v zsh) ✨"
  ;;
"clean_cache")
  find "$HOME" -name '*.zwc' -delete
  ;;
"reload_completions")
  compaudit 2> /dev/null | xargs chmod -R go-w
  zsh -i -c "autoload -U compaudit && autoload -Uz compinit && compinit"

  output::empty_line
  output::answer 'Now restart your terminal'
  ;;
"fix_permissions")
  compaudit 2> /dev/null | xargs chmod -R go-w
  ;;
*)
  exit 1
  ;;
esac
