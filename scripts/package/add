#!/usr/bin/env bash

. "$DOTLY_PATH/scripts/core/_main.sh"
dot::load_library "package.sh"
dot::load_library "_registry.sh" "$(dot::get_script_path)/recipes/"

##? Install a package
##?
##? Usage:
##?    add [-v | --version]
##?    add [-h | --help]
##?    add [--recipe-path <recipe_path>] <package_name> [--skip-recipe]
##?
##? Options:
##?    -h --help     Show script help
##?    -v --version  Show script version
##?
if ! ${DOTLY_INSTALLER:-false}; then
  docs::parse "$@"
else
  package_name=""
  skip_recipe=false
  recipe_path="$(dot::get_script_path)/recipes/"
  while $# -gt 0; do
    case "$1" in
      --recipe-path)
        if [[ "$2" != "_registry" ]]; then
          recipe_path="$2"
        fi
        shift 2
        ;;
      --skip-recipe)
        skip_recipe=true; shift
        ;;
      --version|-v)
        version=true; shift
        ;;
      --help|-h)
        help=true; shift
        ;;
      *)
        package_name="$1"; shift
        ;;
    esac
  done
fi

<<<<<<< HEAD
if [[ $# -lt 1 ]]; then
  exit 1
fi

export PATH="$HOME/.cargo/bin:$PATH"

package::command() {
  local package_manager
  local -r command="$1"
  local -r args=("${@:2}")

  # Package manager
  if platform::is_macos; then
    for package_manager in brew mas ports cargo none; do
      if platform::command_exists "$package_manager"; then
        break
      fi
    done
  else
    for package_manager in apt dnf yum brew pacman cargo none; do
      if platform::command_exists "$package_manager"; then
        break
      fi
    done
  fi

  # No package manager found
  if [[ "$package_manager" == "none" ]]; then
    return 1
  fi

  # Load package manager functions
  local -r file="$DOTLY_PATH/scripts/package/package_managers/$package_manager.sh"

  [[ ! -f "$file" ]] && exit 4
  . "$file"

  # Execute requested function for found package manager
  declare -F "$package_manager::$command" &>/dev/null && "$package_manager::$command" "${args[@]}"
}
=======
SCRIPT_NAME="dot package add"
SCRIPT_VERSION="3.0.0"

if ${version:-}; then
  output::write "${SCRIPT_NAME} v${SCRIPT_VERSION}"
  exit 0
elif ${help:-}; then
  grep '^##?' "$0" | tr '##?' ' '
  exit 0
fi
>>>>>>> feat/improved_package_registry

# No package
[[ -z "${package_name:-}" ]] && exit 1

export PATH="$HOME/.cargo/bin:$PATH"

<<<<<<< HEAD
platform::command_exists "$package_name" || registry::is_installed "$package_name" && log::success "$package_name already installed" && exit 0
=======
package::is_installed "$package_name" && log::success "$package_name already installed" && exit 0
>>>>>>> feat/improved_package_registry

if [[ -z "$skip_recipe" ]] &&\
   [[ -n "$(registry::recipe_exists "$package_name" "${recipe_path:-}")" ]] &&\
   registry::install "$package_name" "${recipe_path:-}" &&\
   registry::is_installed "$package_name" "${recipe_path:-}"
then
  output::write "✅ \`$package_name\` installed"

  exit 0
else
  package::command install "$package_name" 2>&1 | log::file "Trying to install $package_name using $package_manager" || true

  if package::is_installed "$package_name"; then
    output::write "✅ \`$package_name\` installed"

    exit 0
  fi
fi

if ! platform::command_exists "$package_name" && ! registry::is_installed "$package_name"; then
  output::write "❌ \`$package_name\` could not be installed"

  exit 1
fi
