#!/usr/bin/env bash

#shellcheck disable=SC1091
. "${SLOTH_PATH:-$DOTLY_PATH}/scripts/core/src/_main.sh"
dot::load_library "package.sh"
dot::load_library "_registry.sh" "$(dot::get_script_path)/recipes/"

##? Install a package
##?
##? Usage:
##?    add [-v | --version]
##?    add [-h | --help]
##?    add [--recipe-path <recipe_path>] <package_name>
##?
##? Options:
##?    -h --help     Show script help
##?    -v --version  Show script version
##?
if ! ${DOTLY_INSTALLER:-false} && package::is_installed "docpars"; then
  docs::parse "$@"
else
  package_name=""
  version=false
  help=false
  recipe_path="$(dot::get_script_path)/recipes/"
  while [[ $# -gt 0 ]]; do
    case "$1" in
    --recipe-path)
      if [[ "$2" != "_registry" ]]; then
        recipe_path="$2"
      fi
      shift 2
      ;;
    --version | -v)
      version=true
      shift
      ;;
    --help | -h)
      help=true
      shift
      ;;
    *)
      package_name="$1"
      shift
      ;;
    esac
  done
fi

SCRIPT_NAME="sloth package add"
SCRIPT_VERSION="3.0.0"
package_name="$(str::to_lower "$package_name")"

if ${version:-}; then
  output::write "${SCRIPT_NAME} v${SCRIPT_VERSION}"
  exit 0
elif ${help:-}; then
  grep '^##?' "$0" | tr '##? ' ' '
  exit 0
elif [[ -z "${package_name:-}" ]]; then
  output::error "No package name provided"
  exit 1
fi

# If the package is not docpars and docpars is not installed
if [[ "$package_name" != "docpars" ]] && ! package::is_installed "docpars"; then
  script::depends_on docpars
fi

# Load cargo PATH
if [[ -f "$HOME/.cargo/env" ]]; then
  . "$HOME/.cargo/env"
fi

package::is_installed "$package_name" "${recipe_path:-}" && log::success "$package_name already installed" && exit 0

if [[ -z "$skip_recipe" ]] &&
  [[ -n "$(registry::recipe_exists "$package_name" "${recipe_path:-}")" ]] &&
  registry::install "$package_name" "${recipe_path:-}" &&
  registry::is_installed "$package_name" "${recipe_path:-}"; then
  output::write "✅ \`$package_name\` installed"

  exit 0
else
  package::command install "$package_name" 2>&1 || true

  if package::is_installed "$package_name" "${recipe_path:-}"; then
    output::write "✅ \`$package_name\` installed"

    exit 0
  fi
fi

if { [[ "$package_name" == "docpars" ]] && ! registry::is_installed docpars "${recipe_path:-}"; } ||
  { [[ "$package_name" != "docpars" ]] && ! platform::command_exists "$package_name" && ! registry::is_installed "$package_name" "${recipe_path:-}"; }; then
  output::write "❌ \`$package_name\` could not be installed"

  exit 1
fi
