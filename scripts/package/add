#!/usr/bin/env bash

. "$DOTLY_PATH/scripts/core/_main.sh"
dot::load_library "package.sh"
dot::load_library "_registry.sh" "$(dot::get_script_path)/recipes/"

##? Install a package
##?
##? Usage:
##?    add [-v | --version]
##?    add [-h | --help]
##?    add <package_name> [--skip-recipe]
##?
##? Options:
##?    -h --help     Show script help
##?    -v --version  Show script version
##?
if ! ${DOTLY_INSTALLER:-false}; then
  docs::parse "$@"
fi

if [[ $# -lt 1 ]]; then
  exit 1
fi

SCRIPT_NAME="dot package add"
SCRIPT_VERSION="3.0.0"

if ${version:-}; then
  output::write "${SCRIPT_NAME} v${SCRIPT_VERSION}"
  exit 0
fi

export PATH="$HOME/.cargo/bin:$PATH"

package_name="$1"
skip_recipe="${2:-}"

package::is_installed "$package_name" && log::success "$package_name already installed" && exit 0

if [[ -z "$skip_recipe" ]] &&\
   [[ -n "$(registry::recipe_exists "$package_name")" ]] &&\
   registry::install "$package_name" &&\
   registry::is_installed "$package_name"
then
  output::write "✅ \`$package_name\` installed"

  exit 0
else
  package::command install "$package_name" 2>&1 | log::file "Trying to install $package_name using $package_manager" || true

  if package::is_installed "$package_name"; then
    output::write "✅ \`$package_name\` installed"

    exit 0
  fi
fi

if ! platform::command_exists "$package_name" && ! registry::is_installed "$package_name"; then
  output::write "❌ \`$package_name\` could not be installed"

  exit 1
fi
