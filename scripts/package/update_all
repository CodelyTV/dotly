#!/usr/bin/env bash
#shellcheck disable=SC1091

set -euo pipefail

. "${SLOTH_PATH:-$DOTLY_PATH}/scripts/core/src/_main.sh"
. "$DOTLY_PATH/scripts/package/src/package_managers/brew.sh"
. "$DOTLY_PATH/scripts/package/src/package_managers/composer.sh"
. "$DOTLY_PATH/scripts/package/src/package_managers/gem.sh"
. "$DOTLY_PATH/scripts/package/src/package_managers/mas.sh"
. "$DOTLY_PATH/scripts/package/src/package_managers/npm.sh"
. "$DOTLY_PATH/scripts/package/src/package_managers/pip.sh"

update_all_error() {
  [[ -n "${1:-}" ]] && output::clarification "Error updating ${1:-} apps. See \`dot self debug\` for view errors"
}

##? Update all packages
##?
##? Usage:
##?   update_all
docs::parse "$@"

output::h1_without_margin "â™»ï¸  Updating all the apps on your system"
output::clarification "If you want to debug what's happening behind the scenes, you can execute \`dot self debug\` in parallel."

{
  platform::command_exists mas && output::h2 'ðŸŽ App Store' && mas::update_all
} || update_all_error 'ðŸŽ App Store'

{
  platform::command_exists brew && output::h2 'ðŸº Brew' && brew::update_all
} || update_all_error 'ðŸº Brew'

{
  platform::command_exists pip3 && output::h2 'ðŸ pip' && pip::update_all
} || update_all_error 'ðŸ pip'

{
  platform::command_exists composer && output::h2 'ðŸ˜ Composer' && composer::update_all
} || update_all_error 'ðŸ˜ Composer'

{
  platform::command_exists gem && output::h2 'â™¦ï¸  gem' && gem::update_all
} || update_all_error 'â™¦ï¸  gem'

{
  platform::command_exists npm && output::h2 'ðŸŒˆ npm' && npm::update_all
} || update_all_error 'ðŸŒˆ npm'

{
  platform::command_exists cargo && output::h2 'ðŸ“¦ cargo' && cargo install --list | grep -E '^[a-z0-9_-]+ v[0-9.]+:$' | cut -f1 -d' ' | xargs -n1 cargo install
} || update_all_error 'ðŸ“¦ cargo'

{
  platform::command_exists rustup && output::h2 'â˜¢ï¸ Rust compiler' && rustup update
} || update_all_error 'â˜¢ï¸ Rust compiler'

{
  platform::command_exists deno && output::h2 'ðŸ¦• deno' && deno upgrade
} || update_all_error 'ðŸ¦• deno'

{
  platform::command_exists tldr && output::h2 'ðŸ“œ tldr database' && tldr --update
} || update_all_error 'ðŸ“œ tldr database'

output::h2 "Zim Framework" && sudo zsh "$DOTLY_PATH/modules/zimfw/zimfw.zsh" upgrade 2>&1 | log::file "Updating Zim"

output::empty_line
output::solution 'ðŸ‘Œ All your packages have been successfully updated'